---
layout: post
title: 微服务设计与实践原则
categories: SpringCloud
description: 微服务设计与实践原则
keywords: web, micro, design, service
---

整理微服务设计与实践历程，共享给大家。

# 微服务的描述

The description of microserivce by *Martin Fowler*:

- 根据业务模块划分服务种类。
- 每个服务可以独立部署并且互相隔离。
- 通过轻量的 API 调用服务。
- 服务需要保证良好的高可用性。

> 微服务架构是以专注与单一责任的小功能模块为基础、通过 API 相互通信的方式完成复杂业务系统搭建的一种设计思想。

# 演变过程

单体架构(Monolithic) -> 垂直架构 -> SOA 架构 -> 微服务架构

待解决的痛点：

DAO等类似操作代码重复、缓存升级改造、分库分表、数据库复用与耦合、SQL无法集中管理、DB耦合等引发的无关服务被动更新问题；

# 准备工作

- 业务拆分

要合理规划服务之间的界限；

- 服务治理

方便实现服务的发现、治理、熔断、降级等机制；

- 自动测试

尽量做到更多的环节实现自动化。

- 自动运维

方便部署升级、高效自动化运维。

- 服务监控

包括硬件环境、服务状态、系统健康度、接口调用情况、异常的实时告警以及潜在问题的事先预警等等。一句话：没准备好监控，就不要搞微服务。

## 设计原则

- AKF 拆分原则

AKF 扩展立方体： X-水平复制，即多实例集群负载、Z-数据分区、Y-按业务服务功能拆分

- 前后端分离

优化前后端框架、便于接口设计开发和维护

- 无状态服务

将需要被多个服务共享的数据存储到分布式缓存中，让业务服务变成“无状态的计算节点”，便于动态扩展节点。

- Restful 风格

目前较多的有：① Restful ② RPC(Thrift, Dubbo)

建议采用无状态的 HTTP 协议，扩展性强；JSON 报文业务成熟友好。

## *服务拆分原则* (重要)

### 强制条件

- 服务内部应稳定
- 服务应实现相关的方法、必须遵循共同封闭的原则
- 不同服务间应是松耦合的，服务内部改变不影响外部其他服务
- 服务应易于测试性

### 拆分解决方案

- 根据业务拆分(横向拆分)

比如用户服务、订单服务、产品服务等等，基于现有系统的各个业务流程，抽象出各个逻辑上可以独立出的服务，类似拆分代码的服务接口；

- 基础服务下沉

把公共的组件拆分成独立的原子服务，下沉到底层，形成相对独立的原子服务层。

- 基于领域模型拆分

https://www.zhihu.com/question/24013141

https://blog.csdn.net/jek123456/article/details/54691456

https://blog.csdn.net/featuresoft/article/details/52496186

https://blog.csdn.net/huangshulang1234/article/details/78848420

https://blog.csdn.net/Gupaoxueyuan/article/details/79173292

> 标准化的功能，由底层服务为产品层提供标准能力支撑，具有强烈的个别业务特性化的功能，由产品层直接调用更底层的能力自己封装实现。

# 注意问题

- 远程服务调用的性能损耗
- 强一致性VS最终一致性(分布式事务 or CAP 问题)
- 更为复杂的跨服务测试
- 更复杂的运维工作
- 更高要求的整理规划与设计

## 事务一致性问题

大部分业务可以通过 *最终一致性* 解决，极少部分需要采用 *强一致性*。具体策略如下：

### 最终一致性

基于 MQ 等消息中间件实现。

### 强一致性

使用 TCC 框架，需要嵌入分布式事务框架来支持分布式事务。

> 领域驱动设计早已阐明，具有强一致性要求的一组业务概念，属于同一个聚合，不建议拆到不同服务中，从而尽可能避免分布式强事务一致性的处理。
而可以拆分的服务边界，是在限界上下文或者聚合的粒度上。这样的事务一致性属于最终一致性，可以用成熟的工具或者算法处理。




---
